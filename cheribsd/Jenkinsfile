def targets = ['mips-purecap']

def buildCheriBSDImage(String suffix) {
    def app
    stage("Copy CheriBSD ${suffix} artifact") {
        echo "Copying CheriBSD artifacts (artifacts-${suffix}/**)"
        copyArtifacts filter: "artifacts-${suffix}/**", projectName: 'CheriBSD-pipeline/master', selector: lastSuccessful()
        sh """
echo ${suffix}
find .
mv -fv artifacts-${suffix}/* .
tar xJf cheribsd-sysroot.tar.xz
"""
    }
    stage("Build CheriBSD (${suffix}) SDK image") {
        sh 'pwd && cp -f ../cheribsd/Dockerfile . && ls -la'
        app = docker.build("ctsrd/cheribsd-sdk-${suffix}", ".")
    }
    stage("Push CheriBSD (${suffix}) SDK image") {
        docker.withRegistry('https://registry.hub.docker.com', 'docker-hub-credentials') {
            app.push("${env.BUILD_NUMBER}")
            app.push("latest")
        }
    }
}

node("docker") {
    stage('Clone repository') {
        sh "rm -rf build-*"
        /* Let's make sure we have the repository cloned to our workspace */
        checkout scm
        sh "pwd"
    }
    // don't user for loops and closures: http://blog.freeside.co/2013/03/29/groovy-gotcha-for-loops-and-closure-scope/
    stage('Build SDK docker images') {
        parallel targets.collectEntries { String suffix ->
            [suffix, {
                dir("build-${suffix}") {
                    buildCheriBSDImage(suffix)
                }
            }]
        }
    }
    stage("Cleaning up") {
        pwd
        sh "rm -rf build-*"
        sh "ls -laR"
    }
}
